#include "inc/hw_memmap.h"
#include "inc/hw_types.h"
#include "inc/hw_ints.h"
#include "driverlib/timer.h"
#include "driverlib/sysctl.h"
#include "driverlib/gpio.h"
#include "driverlib/pin_map.h"
#include "driverlib/interrupt.h"
#include "trajectory.h"
#include "PID.h"

#define NUM_POINTS 500
#define DEFAULT_FREQ 1

extern PID* Controller;
unsigned long count = 0;
unsigned long trajectorySource = 0x00;

//long trajectoryD[NUM_POINTS] =
//{
//	2192,2262,2331,2399,2467,2534,2599,2663,2725,2785,2842,
//	2896,2948,2997,3043,3085,3123,3158,3189,3216,3239,3257,
//	3271,3281,3287,3288,3285,3277,3265,3248,3228,3203,3174,
//	3141,3104,3064,3020,2973,2923,2870,2813,2755,2694,2631,
//	2567,2501,2433,2365,2296,2227,2157,2088,2019,1951,1883,
//	1817,1753,1690,1629,1571,1514,1461,1411,1364,1320,1280,
//	1243,1210,1181,1156,1136,1119,1107,1099,1096,1097,1103,
//	1113,1127,1145,1168,1195,1226,1261,1299,1341,1387,1436,
//	1488,1542,1599,1659,1721,1785,1850,1917,1985,2053,2122,
//	2192
//};

long trajectoryD[NUM_POINTS] =
{
//		0,127,253,379,502,624,743,860,972,1081,1186,1286,1380,
//		1469,1552,1629,1699,1763,1819,1868,1910,1944,1970,1988,
//		1998,2000,1994,1980,1958,1928,1890,1845,1792,1732,1665,
//		1592,1511,1425,1334,1236,1134,1027,916,802,684,563,441,
//		316,190,63,-63,-190,-316,-441,-563,-684,-802,-916,-1027,
//		-1134,-1236,-1334,-1425,-1511,-1592,-1665,-1732,-1792,
//		-1845,-1890,-1928,-1958,-1980,-1994,-2000,-1998,-1988,
//		-1970,-1944,-1910,-1868,-1819,-1763,-1699,-1629,-1552,
//		-1469,-1380,-1286,-1186,-1081,-972,-860,-743,-624,-502,
//		-379,-253,-127,0
		//-500,-483,-466,-448,-431,-414,-397,-380,-363,-346,-328,-311,-294,-277,-260,-243,-226,-209,-192,-175,-158,-141,-124,-107,-90,-74,-57,-40,-23,-7,10,27,43,60,76,93,109,126,142,158,174,191,207,223,239,255,271,287,303,318,334,350,365,381,396,412,427,442,458,473,488,503,518,533,547,562,577,591,606,620,635,649,663,677,691,705,719,733,746,760,774,787,800,814,827,840,853,865,878,891,903,916,928,941,953,965,977,989,1000,1012,1023,1035,1046,1057,1069,1080,1090,1101,1112,1122,1133,1143,1153,1163,1173,1183,1193,1203,1212,1221,1231,1240,1249,1258,1266,1275,1284,1292,1300,1308,1316,1324,1332,1340,1347,1354,1362,1369,1376,1383,1389,1396,1402,1409,1415,1421,1427,1432,1438,1443,1449,1454,1459,1464,1469,1474,1478,1482,1487,1491,1495,1499,1502,1506,1509,1512,1516,1519,1521,1524,1527,1529,1531,1533,1535,1537,1539,1540,1542,1543,1544,1545,1546,1547,1547,1548,1548,1548,1548,1548,1547,1547,1546,1546,1545,1544,1542,1541,1540,1538,1536,1534,1532,1530,1528,1525,1523,1520,1517,1514,1511,1507,1504,1500,1497,1493,1489,1485,1480,1476,1471,1466,1462,1457,1451,1446,1441,1435,1430,1424,1418,1412,1405,1399,1393,1386,1379,1372,1365,1358,1351,1343,1336,1328,1320,1312,1304,1296,1288,1279,1271,1262,1253,1244,1235,1226,1217,1207,1198,1188,1178,1168,1158,1148,1138,1128,1117,1107,1096,1085,1074,1063,1052,1041,1029,1018,1006,994,983,971,959,947,934,922,910,897,885,872,859,846,833,820,807,794,780,767,753,740,726,712,698,684,670,656,642,628,613,599,584,570,555,540,525,510,495,480,465,450,435,419,404,389,373,358,342,326,310,295,279,263,247,231,215,199,182,166,150,134,117,101,84,68,51,35,18,2,-15,-32,-48,-65,-82,-99,-116,-133,-150,-166,-183,-200,-217,-234,-252,-269,-286,-303,-320,-337,-354,-371,-388,-406,-423,-440,-457,-474,-491,-509,-526,-543,-560,-577,-594,-612,-629,-646,-663,-680,-697,-714,-731,-748,-766,-783,-800,-817,-834,-850,-867,-884,-901,-918,-935,-952,-968,-985,-1002,-1018,-1035,-1051,-1068,-1084,-1101,-1117,-1134,-1150,-1166,-1182,-1199,-1215,-1231,-1247,-1263,-1279,-1295,-1310,-1326,-1342,-1358,-1373,-1389,-1404,-1419,-1435,-1450,-1465,-1480,-1495,-1510,-1525,-1540,-1555,-1570,-1584,-1599,-1613,-1628,-1642,-1656,-1670,-1684,-1698,-1712,-1726,-1740,-1753,-1767,-1780,-1794,-1807,-1820,-1833,-1846,-1859,-1872,-1885,-1897,-1910,-1922,-1934,-1947,-1959,-1971,-1983,-1994,-2006,-2018,-2029,-2041,-2052,-2063,-2074,-2085,-2096,-2107,-2117,-2128,-2138,-2148,-2158,-2168,-2178,-2188,-2198,-2207,-2217,-2226,-2235,-2244,-2253,-2262,-2271,-2279,-2288,-2296,-2304,-2312,-2320,-2328,-2336,-2343,-2351,-2358,-2365,-2372,-2379,-2386,-2393,-2399,-2405,-2412,-2418,-2424,-2430,-2435,-2441,-2446,-2451,-2457,-2462,-2466,-2471,-2476,-2480,-2485,-2489,-2493,-2497,-2500,-2504,-2507,-2511,-2514,-2517,-2520,-2523,-2525,-2528,-2530,-2532,-2534,-2536,-2538,-2540,-2541,-2542,-2544,-2545,-2546,-2546,-2547,-2547,-2548,-2548,-2548,-2548,-2548,-2547,-2547,-2546,-2545,-2544,-2543,-2542,-2540,-2539,-2537,-2535,-2533,-2531,-2529,-2527,-2524,-2521,-2519,-2516,-2512,-2509,-2506,-2502,-2499,-2495,-2491,-2487,-2482,-2478,-2474,-2469,-2464,-2459,-2454,-2449,-2443,-2438,-2432,-2427,-2421,-2415,-2409,-2402,-2396,-2389,-2383,-2376,-2369,-2362,-2354,-2347,-2340,-2332,-2324,-2316,-2308,-2300,-2292,-2284,-2275,-2266,-2258,-2249,-2240,-2231,-2221,-2212,-2203,-2193,-2183,-2173,-2163,-2153,-2143,-2133,-2122,-2112,-2101,-2090,-2080,-2069,-2057,-2046,-2035,-2023,-2012,-2000,-1989,-1977,-1965,-1953,-1941,-1928,-1916,-1903,-1891,-1878,-1865,-1853,-1840,-1827,-1814,-1800,-1787,-1774,-1760,-1746,-1733,-1719,-1705,-1691,-1677,-1663,-1649,-1635,-1620,-1606,-1591,-1577,-1562,-1547,-1533,-1518,-1503,-1488,-1473,-1458,-1442,-1427,-1412,-1396,-1381,-1365,-1350,-1334,-1318,-1303,-1287,-1271,-1255,-1239,-1223,-1207,-1191,-1174,-1158,-1142,-1126,-1109,-1093,-1076,-1060,-1043,-1027,-1010,-993,-977,-960,-943,-926,-910,-893,-876,-859,-842,-825,-808,-791,-774,-757,-740,-723,-706,-689,-672,-654,-637,-620,-603,-586,-569,-552,-534,-517,-500
		0,-8,-16,-25,-33,-41,-49,-58,-66,-74,-82,-90,-99,-107,-115,-123,-132,-140,-148,-156,-164,-173,-181,-189,-197,-206,-214,-222,-230,-239,-247,-255,-263,-271,-280,-288,-296,-304,-313,-321,-329,-337,-345,-354,-362,-370,-378,-387,-395,-403,-411,-419,-428,-436,-444,-452,-461,-469,-477,-485,-493,-502,-510,-518,-526,-535,-543,-551,-559,-568,-576,-584,-592,-600,-609,-617,-625,-633,-642,-650,-658,-666,-674,-683,-691,-699,-707,-716,-724,-732,-740,-748,-757,-765,-773,-781,-790,-798,-806,-814,-822,-831,-839,-847,-855,-864,-872,-880,-888,-897,-905,-913,-921,-929,-938,-946,-954,-962,-971,-979,-987,-995,-1003,-1012,-1020,-1028,-1036,-1045,-1053,-1061,-1069,-1077,-1086,-1094,-1102,-1110,-1119,-1127,-1135,-1143,-1151,-1160,-1168,-1176,-1184,-1193,-1201,-1209,-1217,-1226,-1234,-1242,-1250,-1258,-1267,-1275,-1283,-1291,-1300,-1308,-1316,-1324,-1332,-1341,-1349,-1357,-1365,-1374,-1382,-1390,-1398,-1406,-1415,-1423,-1431,-1439,-1448,-1456,-1464,-1472,-1480,-1489,-1497,-1505,-1513,-1522,-1530,-1538,-1546,-1555,-1563,-1571,-1579,-1587,-1596,-1604,-1612,-1620,-1629,-1637,-1645,-1653,-1661,-1670,-1678,-1686,-1694,-1703,-1711,-1719,-1727,-1735,-1744,-1752,-1760,-1768,-1777,-1785,-1793,-1801,-1809,-1818,-1826,-1834,-1842,-1851,-1859,-1867,-1875,-1884,-1892,-1900,-1908,-1916,-1925,-1933,-1941,-1949,-1958,-1966,-1974,-1982,-1990,-1999,-2007,-2015,-2023,-2032,-2040,-2048,-2048,-2040,-2032,-2023,-2015,-2007,-1999,-1990,-1982,-1974,-1966,-1958,-1949,-1941,-1933,-1925,-1916,-1908,-1900,-1892,-1884,-1875,-1867,-1859,-1851,-1842,-1834,-1826,-1818,-1809,-1801,-1793,-1785,-1777,-1768,-1760,-1752,-1744,-1735,-1727,-1719,-1711,-1703,-1694,-1686,-1678,-1670,-1661,-1653,-1645,-1637,-1629,-1620,-1612,-1604,-1596,-1587,-1579,-1571,-1563,-1555,-1546,-1538,-1530,-1522,-1513,-1505,-1497,-1489,-1480,-1472,-1464,-1456,-1448,-1439,-1431,-1423,-1415,-1406,-1398,-1390,-1382,-1374,-1365,-1357,-1349,-1341,-1332,-1324,-1316,-1308,-1300,-1291,-1283,-1275,-1267,-1258,-1250,-1242,-1234,-1226,-1217,-1209,-1201,-1193,-1184,-1176,-1168,-1160,-1151,-1143,-1135,-1127,-1119,-1110,-1102,-1094,-1086,-1077,-1069,-1061,-1053,-1045,-1036,-1028,-1020,-1012,-1003,-995,-987,-979,-971,-962,-954,-946,-938,-929,-921,-913,-905,-897,-888,-880,-872,-864,-855,-847,-839,-831,-822,-814,-806,-798,-790,-781,-773,-765,-757,-748,-740,-732,-724,-716,-707,-699,-691,-683,-674,-666,-658,-650,-642,-633,-625,-617,-609,-600,-592,-584,-576,-568,-559,-551,-543,-535,-526,-518,-510,-502,-493,-485,-477,-469,-461,-452,-444,-436,-428,-419,-411,-403,-395,-387,-378,-370,-362,-354,-345,-337,-329,-321,-313,-304,-296,-288,-280,-271,-263,-255,-247,-239,-230,-222,-214,-206,-197,-189,-181,-173,-164,-156,-148,-140,-132,-123,-115,-107,-99,-90,-82,-74,-66,-58,-49,-41,-33,-25,-16,-8,0


};

long trajectory1 = 0;

void initTrajectoryTimerInt(void) {
	unsigned long ulPeriod = 0;
	//Enable Timer 3
	SysCtlPeripheralEnable(SYSCTL_PERIPH_TIMER3);
	//Initialize timer period to default setting
	ulPeriod = SysCtlClockGet()/(NUM_POINTS*DEFAULT_FREQ);
	TimerConfigure(TIMER3_BASE, TIMER_CFG_PERIODIC);
	TimerLoadSet(TIMER3_BASE, TIMER_A, ulPeriod);
	//Enable interrupt for timer 3
	IntEnable(INT_TIMER3A);
	//Configure Timer3A interrupt
	TimerIntEnable(TIMER3_BASE, TIMER_TIMA_TIMEOUT);
	//Enable Timer3A
	//TimerEnable(TIMER3_BASE, TIMER_A);
	//IntMasterEnable();
}

void setTrajectoryHandler(void) {
	TimerIntClear(TIMER3_BASE, TIMER_TIMA_TIMEOUT);
	Controller->x = (trajectoryD + count);
	count = (count + 1) % NUM_POINTS;
}

void setTrajectorySource(unsigned long src){
	trajectorySource = src;
}

void setTrajectoryTimer(unsigned long newFreq) {
	unsigned long ulPeriod = 0;
	//Calculate desired period of the timer
	ulPeriod = SysCtlClockGet()/(NUM_POINTS*newFreq);
	//Set timer to the desired period
	TimerLoadSet(TIMER3_BASE, TIMER_A, ulPeriod);
}

void trajectoryEnable(void) {
	//Enable Timer3A
	if(trajectorySource == 0){
		TimerEnable(TIMER3_BASE, TIMER_A);
	}else{
		Controller->x = &trajectory1;
	}
}

void setTrajectoryElement(signed long pt){
	trajectory1 = pt;
}

void trajectoryDisable(void) {
	//Disable Timer3A
	TimerDisable(TIMER3_BASE, TIMER_A);
}

